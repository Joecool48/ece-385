
#include <stdio.h>
#include "../include/background.h"
#include "../include/init.h"
#include "../include/config.h"
#include <fstream>
#include <iostream>
#include <string>
#include <stdlib.h>
#include <ostream>
#include <istream>
#include "../include/sim.h"
#include <unistd.h>
using namespace std;

string strip_newline(string str) {
	if (str.length() <= 1) return "";
	return str.substr(str.length() - 1);
}

int main ()
{

	std::cout << "Begin game" << std::endl;
	// Init the simulator
	Sim::initSim();
	Background * background = new Background ();
	Player * player = new Player(30, 30); // Make a player at 30, 30
	background->setPlayer(player); // Each contains the other
	player->setBackground(background);
	setBackgroundObjectWorld1(background); // Add the world 1 object colliders
	Keyboard::initKeyboard(); // Startup the keyboard
	char buff[256];
	string line;
	while (true) {
		Sim::scancode_file.seekp(0, ios_base::beg);
		Sim::scancode_file >> line;
		std::cout << "Scancode:" << line << std::endl;
		scancode = atoi((line == "" ? "0" : line).c_str());
		Keyboard::updateKeys();
		background->updateBackground(); // Function that does everything in the game.

		// Wait for hardware, and signal that you're done
		*SOFTWARE_DONE = 1;
		Sim::software_done_file.seekp(0, ios_base::beg);
		Sim::software_done_file << 1 << std::flush;
		Sim::hardware_done_file.seekg(0, ios_base::beg);
		getline(Sim::hardware_done_file, line);
		//line = strip_newline(line);
		*HARDWARE_DONE = atoi(line.c_str());
		std::cout << "Line: " << line << std::endl;
		fstream stream("/home/joey/courses/ece385/final_project/python_sim/HARDWARE_DONE");
		while (!(*HARDWARE_DONE)) { // Should update at 60ish fps
			std::cout << "Before" << std::endl;
			Sim::hardware_done_file.seekg(0, ios_base::beg);
			std::cout << "Contents = " << Sim::hardware_done_file.rdbuf();
			*HARDWARE_DONE = atoi(line.c_str());
			usleep(500000);
		}
		*SOFTWARE_DONE = 0;
		Sim::software_done_file.seekp(0, ios_base::beg);
		Sim::software_done_file << 0 << std::flush;
		usleep(500000);
	}
	return 0;
}
